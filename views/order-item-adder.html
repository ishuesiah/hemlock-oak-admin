<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Items to Orders - Hemlock & Oak</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f7f7fb; color: #333; }

    /* Layout with sidebar */
    .layout { display: grid; grid-template-columns: 220px 1fr; min-height: 100vh; }
    .sidebar { background: #111827; color: #fff; padding: 1rem; display: flex; flex-direction: column; gap: .5rem; }
    .nav-title { font-weight: 700; opacity: .9; margin-bottom: .5rem; }
    .nav-link { display: block; color: #c7cbe1; text-decoration: none; padding: .5rem .6rem; border-radius: 6px; }
    .nav-link:hover { background: #1f2937; color: #fff; }
    .nav-link.active { background: #4f46e5; color: #fff; }

    /* Main content area */
    .main-content { display: flex; flex-direction: column; }

    /* Header */
    .header { background: #fff; border-bottom: 1px solid #e0e0e0; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    .header h1 { font-size: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .header-actions { display: flex; gap: .75rem; align-items: center; }

    /* Status indicator */
    .status-indicator { font-size: .85rem; padding: .4rem .75rem; border-radius: 6px; background: #e0f2fe; color: #0369a1; border: 1px solid #7dd3fc; }
    .status-indicator.stale { background: #fef3c7; color: #d97706; border-color: #fcd34d; }

    /* Content */
    .content { padding: 1.5rem; }
    .card { background: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,.08); margin-bottom: 1.5rem; }
    .card h2 { font-size: 1.1rem; margin-bottom: 1rem; color: #333; }

    /* Controls bar */
    .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap; }
    .search-box { flex: 1; max-width: 400px; position: relative; }
    .search-box input { width: 100%; padding: .6rem .6rem .6rem 2.5rem; border: 1px solid #e0e0e0; border-radius: 6px; font-size: .9rem; }
    .search-box::before { content: 'üîç'; position: absolute; left: .75rem; top: 50%; transform: translateY(-50%); font-size: 1rem; }
    .controls-right { display: flex; gap: .75rem; align-items: center; }

    /* Item config */
    .item-config { background: #f8f9fa; border-radius: 8px; padding: 1.25rem; margin-bottom: 1.5rem; }
    .item-config h3 { font-size: .95rem; margin-bottom: 1rem; color: #444; }
    .config-row { display: grid; grid-template-columns: 1fr 2fr 1fr 1fr; gap: .75rem; margin-bottom: .75rem; }
    .config-row input { width: 100%; padding: .5rem; border: 1px solid #e0e0e0; border-radius: 6px; font-size: .85rem; }
    .config-row input:focus { outline: none; border-color: #667eea; }
    .config-row input:disabled { background: #f5f5f5; color: #999; cursor: not-allowed; }
    .config-row label { font-size: .8rem; font-weight: 600; color: #666; margin-bottom: .3rem; display: block; }

    /* Checkbox */
    .checkbox-group { background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; padding: .75rem; }
    .checkbox-label { display: flex; align-items: center; cursor: pointer; font-size: .85rem; }
    .checkbox-label input[type="checkbox"] { margin-right: .5rem; width: 16px; height: 16px; cursor: pointer; }

    /* Table */
    .table-container { background: #fff; border-radius: 8px; overflow: hidden; border: 1px solid #e0e0e0; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: #f8f9fa; border-bottom: 2px solid #e0e0e0; }
    th { padding: .75rem; text-align: left; font-weight: 600; font-size: .8rem; text-transform: uppercase; letter-spacing: .5px; color: #666; white-space: nowrap; }
    td { padding: .75rem; border-bottom: 1px solid #f0f0f0; font-size: .85rem; }
    tbody tr:hover { background: #f8f9fa; }
    tbody tr.selected { background: #eff6ff; }
    td input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    /* Pagination */
    .pagination { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8f9fa; border-top: 1px solid #e0e0e0; font-size: .85rem; }
    .pagination-info { color: #666; }
    .pagination-buttons { display: flex; gap: .5rem; }
    .pagination-buttons button { padding: .4rem .75rem; border: 1px solid #e0e0e0; background: #fff; border-radius: 4px; cursor: pointer; font-size: .85rem; }
    .pagination-buttons button:disabled { opacity: 0.5; cursor: not-allowed; }
    .pagination-buttons button:not(:disabled):hover { background: #f5f5f5; }
    .pagination-buttons button.active { background: #667eea; color: #fff; border-color: #667eea; }

    /* Buttons */
    .btn { padding: .65rem 1.25rem; border-radius: 6px; border: none; font-size: .85rem; cursor: pointer; transition: all .2s; font-weight: 600; display: inline-block; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(102,126,234,.3); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: #6c757d; color: #fff; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-small { padding: .4rem .75rem; font-size: .8rem; }

    /* Loading */
    .loading { display: none; text-align: center; padding: 3rem; }
    .loading.show { display: block; }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Results */
    .results { display: none; }
    .results.show { display: block; }
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-card { background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 1px solid #e0e0e0; text-align: center; }
    .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: .25rem; }
    .stat-value.success { color: #10b981; }
    .stat-value.skipped { color: #f59e0b; }
    .stat-value.failed { color: #ef4444; }
    .stat-label { font-size: .8rem; color: #666; text-transform: uppercase; letter-spacing: .5px; }

    /* Result items */
    .result-item { background: #fff; padding: 1rem; border-radius: 6px; margin-bottom: .75rem; border-left: 4px solid #10b981; }
    .result-item.error { border-left-color: #ef4444; background: #fef2f2; }
    .result-item.skipped { border-left-color: #f59e0b; background: #fffbeb; }
    .result-item strong { display: block; margin-bottom: .5rem; color: #333; }
    .result-item .message { font-size: .9rem; color: #666; }
    .result-item .meta { font-size: .8rem; color: #999; margin-top: .5rem; }

    /* Empty state */
    .empty-state { text-align: center; padding: 3rem; color: #999; }
    .empty-state h3 { color: #666; margin-bottom: .5rem; }

    /* Order detail drawer */
    .order-drawer { position: fixed; top: 0; right: -600px; width: 600px; height: 100vh; background: #fff; box-shadow: -4px 0 12px rgba(0,0,0,.15); z-index: 1000; transition: right .3s; overflow-y: auto; }
    .order-drawer.open { right: 0; }
    .order-drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.4); z-index: 999; display: none; }
    .order-drawer-overlay.show { display: block; }

    .drawer-header { background: #f8f9fa; padding: 1.5rem; border-bottom: 2px solid #e0e0e0; position: sticky; top: 0; z-index: 10; }
    .drawer-header h2 { font-size: 1.2rem; margin-bottom: .5rem; color: #333; }
    .drawer-header .order-status { display: inline-block; padding: .25rem .75rem; border-radius: 4px; background: #fef3c7; color: #d97706; font-size: .8rem; font-weight: 600; text-transform: uppercase; }
    .drawer-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; padding: .5rem; }
    .drawer-close:hover { color: #333; }

    .drawer-content { padding: 1.5rem; }
    .drawer-section { margin-bottom: 2rem; }
    .drawer-section h3 { font-size: 1rem; color: #333; margin-bottom: 1rem; border-bottom: 2px solid #e0e0e0; padding-bottom: .5rem; }

    .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
    .info-item { }
    .info-label { font-size: .75rem; color: #666; text-transform: uppercase; letter-spacing: .5px; margin-bottom: .25rem; }
    .info-value { font-size: .9rem; color: #333; font-weight: 500; }

    .line-items-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .line-items-table th { text-align: left; padding: .75rem; background: #f8f9fa; font-size: .8rem; font-weight: 600; color: #666; border-bottom: 2px solid #e0e0e0; }
    .line-items-table td { padding: .75rem; border-bottom: 1px solid #f0f0f0; font-size: .85rem; }
    .line-items-table .item-name { font-weight: 500; color: #333; }
    .line-items-table .item-sku { color: #666; font-size: .8rem; }
    .line-items-table .item-options { font-size: .75rem; color: #999; margin-top: .25rem; padding-left: 1rem; }
    .line-items-table .item-option { display: block; }

    .address-box { background: #f8f9fa; padding: 1rem; border-radius: 6px; border: 1px solid #e0e0e0; }
    .address-box .name { font-weight: 600; margin-bottom: .5rem; }
    .address-box .line { font-size: .85rem; color: #666; margin-bottom: .25rem; }

    .cost-summary { background: #f8f9fa; padding: 1rem; border-radius: 6px; border: 1px solid #e0e0e0; }
    .cost-row { display: flex; justify-content: space-between; padding: .5rem 0; font-size: .9rem; }
    .cost-row.total { border-top: 2px solid #e0e0e0; margin-top: .5rem; padding-top: .75rem; font-weight: 600; font-size: 1rem; }

    .shipping-info { background: #e0f2fe; padding: 1rem; border-radius: 6px; border: 1px solid #7dd3fc; }
    .shipping-info .service { font-weight: 600; color: #0369a1; margin-bottom: .5rem; }
    .shipping-info .carrier { font-size: .85rem; color: #666; }
    .shipping-info .cost { font-size: 1.1rem; font-weight: 600; color: #0369a1; margin-top: .5rem; }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <div class="nav-title">Hemlock & Oak</div>
      <a class="nav-link" href="/">Product Manager</a>
      <a class="nav-link" href="/shipstation">ShipStation Customs</a>
      <a class="nav-link" href="/vip-customers">VIP Customers</a>
      <a class="nav-link" href="/order-formatter">Order Formatter</a>
      <a class="nav-link" href="/order-change-detector">Order Change Detector</a>
      <a class="nav-link active" href="/order-item-adder">Add Items to Orders</a>
      <div style="margin-top:auto"></div>
      <a class="nav-link" href="/logout">Logout</a>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <header class="header">
        <h1>üéÅ Add Items to Orders</h1>
        <div class="header-actions">
          <span class="status-indicator" id="cacheStatus">Loading...</span>
          <button class="btn btn-small btn-secondary" onclick="refreshOrders()">Refresh</button>
        </div>
      </header>

      <div class="content">
        <!-- Item Configuration -->
        <div class="card">
          <h2>Item Configuration</h2>
          <div class="item-config">
            <div class="config-row">
              <div>
                <label>SKU</label>
                <input type="text" id="itemSku" value="LIST-DEF" placeholder="SKU">
              </div>
              <div>
                <label>Product Name</label>
                <input type="text" id="itemName" value="Complimentary stickers" placeholder="Product name">
              </div>
              <div>
                <label>Quantity</label>
                <input type="number" id="itemQuantity" value="2" step="1" min="1" placeholder="1">
              </div>
              <div>
                <label>Unit Price ($)</label>
                <input type="number" id="itemPrice" value="0.50" step="0.01" min="0" placeholder="0.00">
              </div>
            </div>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="useDefaultItem" checked>
                <span>Use default item (Complimentary stickers, 2 qty @ $0.50 each = $1.00 total)</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Order Selection -->
        <div class="card">
          <h2>Select Unfulfilled Orders</h2>

          <!-- Controls -->
          <div class="controls">
            <div class="search-box">
              <input type="text" id="searchBox" placeholder="Search by order number, customer name, or email..." oninput="filterOrders()">
            </div>
            <div class="controls-right">
              <span id="selectedCount">0 selected</span>
              <button class="btn btn-small btn-secondary" onclick="selectAll()">Select All</button>
              <button class="btn btn-small btn-secondary" onclick="clearSelection()">Clear</button>
            </div>
          </div>

          <!-- Loading State -->
          <div class="loading" id="ordersLoading">
            <div class="spinner"></div>
            <p>Loading unfulfilled orders...</p>
          </div>

          <!-- Orders Table -->
          <div class="table-container" id="ordersTable" style="display:none">
            <table>
              <thead>
                <tr>
                  <th style="width:40px"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
                  <th>Order #</th>
                  <th>Customer</th>
                  <th>Email</th>
                  <th>Date</th>
                  <th>Items</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody id="ordersTableBody">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
            <div class="pagination">
              <div class="pagination-info" id="paginationInfo">Showing 0-0 of 0</div>
              <div class="pagination-buttons">
                <button onclick="previousPage()" id="prevBtn">Previous</button>
                <span id="pageNumbers"></span>
                <button onclick="nextPage()" id="nextBtn">Next</button>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div class="empty-state" id="emptyState" style="display:none">
            <h3>No unfulfilled orders found</h3>
            <p>There are currently no awaiting shipment orders in ShipStation.</p>
          </div>

          <!-- Action Button -->
          <div style="margin-top:1.5rem; text-align:right">
            <button class="btn btn-primary" id="addItemBtn" onclick="addItemsToSelectedOrders()" disabled>
              Add Item to Selected Orders
            </button>
          </div>
        </div>

        <!-- Results -->
        <div class="card results" id="results">
          <h2>Results</h2>
          <div class="stats" id="stats"></div>
          <div id="resultDetails"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Detail Drawer -->
  <div class="order-drawer-overlay" id="orderDrawerOverlay" onclick="closeOrderDrawer()"></div>
  <div class="order-drawer" id="orderDrawer">
    <div class="drawer-header">
      <button class="drawer-close" onclick="closeOrderDrawer()">√ó</button>
      <h2 id="drawerOrderNumber">Loading...</h2>
      <span class="order-status" id="drawerOrderStatus">-</span>
    </div>
    <div class="drawer-content" id="drawerContent">
      <div class="loading show">
        <div class="spinner"></div>
        <p>Loading order details...</p>
      </div>
    </div>
  </div>

  <script>
    let allOrders = [];
    let filteredOrders = [];
    let currentPage = 1;
    const ordersPerPage = 50;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadOrders();
      setupItemConfiguration();
    });

    // Item configuration
    function setupItemConfiguration() {
      document.getElementById('useDefaultItem').addEventListener('change', function() {
        const useDefault = this.checked;
        document.getElementById('itemSku').disabled = useDefault;
        document.getElementById('itemName').disabled = useDefault;
        document.getElementById('itemQuantity').disabled = useDefault;
        document.getElementById('itemPrice').disabled = useDefault;

        if (useDefault) {
          document.getElementById('itemSku').value = 'LIST-DEF';
          document.getElementById('itemName').value = 'Complimentary stickers';
          document.getElementById('itemQuantity').value = '2';
          document.getElementById('itemPrice').value = '0.50';
        }
      });

      // Initialize disabled
      document.getElementById('itemSku').disabled = true;
      document.getElementById('itemName').disabled = true;
      document.getElementById('itemQuantity').disabled = true;
      document.getElementById('itemPrice').disabled = true;
    }

    // Load orders from API
    async function loadOrders() {
      document.getElementById('ordersLoading').classList.add('show');
      document.getElementById('ordersTable').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';

      try {
        const response = await fetch('/api/shipstation/unfulfilled-orders');
        const data = await response.json();

        allOrders = data.orders || [];
        filteredOrders = [...allOrders];

        // Update cache status
        const cacheStatus = document.getElementById('cacheStatus');
        if (data.isStale) {
          cacheStatus.textContent = 'Cache updating...';
          cacheStatus.className = 'status-indicator stale';
        } else {
          const age = Math.round(data.age / 1000 / 60);
          cacheStatus.textContent = `Updated ${age}m ago`;
          cacheStatus.className = 'status-indicator';
        }

        if (allOrders.length === 0) {
          document.getElementById('emptyState').style.display = 'block';
        } else {
          document.getElementById('ordersTable').style.display = 'block';
          currentPage = 1;
          renderOrders();
        }
      } catch (error) {
        alert('Error loading orders: ' + error.message);
        console.error('Error:', error);
      } finally {
        document.getElementById('ordersLoading').classList.remove('show');
      }
    }

    // Refresh orders (force sync)
    async function refreshOrders() {
      const cacheStatus = document.getElementById('cacheStatus');
      cacheStatus.textContent = 'Refreshing...';
      cacheStatus.className = 'status-indicator stale';

      try {
        await fetch('/api/shipstation/unfulfilled-orders/refresh', { method: 'POST' });
        await loadOrders();
      } catch (error) {
        alert('Error refreshing orders: ' + error.message);
      }
    }

    // Filter orders by search
    function filterOrders() {
      const search = document.getElementById('searchBox').value.toLowerCase();
      filteredOrders = allOrders.filter(order => {
        return order.orderNumber.toLowerCase().includes(search) ||
               order.customerName.toLowerCase().includes(search) ||
               (order.customerEmail || '').toLowerCase().includes(search);
      });
      currentPage = 1;
      renderOrders();
    }

    // Render orders table
    function renderOrders() {
      const start = (currentPage - 1) * ordersPerPage;
      const end = start + ordersPerPage;
      const pageOrders = filteredOrders.slice(start, end);

      const tbody = document.getElementById('ordersTableBody');
      tbody.innerHTML = '';

      pageOrders.forEach(order => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="checkbox" class="order-checkbox" value="${order.orderNumber}" onchange="updateSelectedCount()"></td>
          <td><a href="javascript:void(0)" onclick="openOrderDrawer('${order.orderNumber}')" style="color:#667eea;text-decoration:none;font-weight:600"><strong>${order.orderNumber}</strong></a></td>
          <td>${order.customerName}</td>
          <td>${order.customerEmail || '-'}</td>
          <td>${new Date(order.orderDate).toLocaleDateString()}</td>
          <td>${order.itemCount}</td>
          <td>$${order.orderTotal.toFixed(2)}</td>
        `;
        tbody.appendChild(row);
      });

      // Update pagination info
      const totalOrders = filteredOrders.length;
      const showingStart = totalOrders === 0 ? 0 : start + 1;
      const showingEnd = Math.min(end, totalOrders);
      document.getElementById('paginationInfo').textContent = `Showing ${showingStart}-${showingEnd} of ${totalOrders}`;

      // Update buttons
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = end >= totalOrders;

      // Update page numbers
      const totalPages = Math.ceil(totalOrders / ordersPerPage);
      const pageNumbers = document.getElementById('pageNumbers');
      pageNumbers.innerHTML = '';
      for (let i = 1; i <= Math.min(totalPages, 5); i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.onclick = () => { currentPage = i; renderOrders(); };
        if (i === currentPage) btn.className = 'active';
        pageNumbers.appendChild(btn);
      }

      updateSelectedCount();
    }

    // Pagination
    function previousPage() {
      if (currentPage > 1) {
        currentPage--;
        renderOrders();
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderOrders();
      }
    }

    // Selection
    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('.order-checkbox:checked');
      const count = checkboxes.length;
      document.getElementById('selectedCount').textContent = `${count} selected`;
      document.getElementById('addItemBtn').disabled = count === 0;
    }

    function selectAll() {
      document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = true);
      updateSelectedCount();
    }

    function clearSelection() {
      document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('selectAllCheckbox').checked = false;
      updateSelectedCount();
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllCheckbox').checked;
      document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = selectAll);
      updateSelectedCount();
    }

    // Add items to selected orders
    async function addItemsToSelectedOrders() {
      const checkboxes = document.querySelectorAll('.order-checkbox:checked');
      const orderNumbers = Array.from(checkboxes).map(cb => cb.value);

      if (orderNumbers.length === 0) {
        alert('Please select at least one order');
        return;
      }

      const itemData = {
        sku: document.getElementById('itemSku').value,
        name: document.getElementById('itemName').value,
        quantity: parseInt(document.getElementById('itemQuantity').value),
        price: parseFloat(document.getElementById('itemPrice').value)
      };

      // Disable button
      const btn = document.getElementById('addItemBtn');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      try {
        const response = await fetch('/api/shipstation/orders/add-item', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderNumbers, item: itemData })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Failed to add items');
        }

        // Display results
        displayResults(result);

        // Reload orders to refresh the list
        await loadOrders();

      } catch (error) {
        alert('Error: ' + error.message);
        console.error('Error:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Add Item to Selected Orders';
      }
    }

    // Display results
    function displayResults(result) {
      document.getElementById('results').classList.add('show');

      const statsHtml = `
        <div class="stat-card">
          <div class="stat-value">${result.total || 0}</div>
          <div class="stat-label">Total Orders</div>
        </div>
        <div class="stat-card">
          <div class="stat-value success">${result.successful || 0}</div>
          <div class="stat-label">Successful</div>
        </div>
        <div class="stat-card">
          <div class="stat-value skipped">${result.skipped || 0}</div>
          <div class="stat-label">Skipped</div>
        </div>
        <div class="stat-card">
          <div class="stat-value failed">${result.failed || 0}</div>
          <div class="stat-label">Failed</div>
        </div>
      `;
      document.getElementById('stats').innerHTML = statsHtml;

      let detailsHtml = '';
      if (result.details && result.details.length > 0) {
        result.details.forEach(detail => {
          const statusClass = detail.status === 'error' ? 'error' :
                            detail.status === 'skipped' ? 'skipped' : '';

          detailsHtml += `
            <div class="result-item ${statusClass}">
              <strong>Order ${detail.orderNumber}</strong>
              <div class="message">
                ${detail.status === 'error' ?
                  `‚ùå Error: ${detail.error}` :
                  detail.status === 'skipped' ?
                  `‚è© ${detail.message || 'Already has item'}` :
                  `‚úÖ ${detail.message || 'Success'}`
                }
              </div>
              ${detail.itemsCount || detail.customsCount ? `
                <div class="meta">
                  ${detail.itemsCount ? `Items: ${detail.itemsCount}` : ''}
                  ${detail.customsCount ? ` | Customs: ${detail.customsCount}` : ''}
                </div>
              ` : ''}
            </div>
          `;
        });
      }

      document.getElementById('resultDetails').innerHTML = detailsHtml;

      // Scroll to results
      document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    }

    // Order detail drawer functions
    async function openOrderDrawer(orderNumber) {
      const drawer = document.getElementById('orderDrawer');
      const overlay = document.getElementById('orderDrawerOverlay');
      const content = document.getElementById('drawerContent');

      // Show drawer and overlay
      drawer.classList.add('open');
      overlay.classList.add('show');

      // Set order number in header
      document.getElementById('drawerOrderNumber').textContent = `Order ${orderNumber}`;

      // Show loading
      content.innerHTML = '<div class="loading show"><div class="spinner"></div><p>Loading order details...</p></div>';

      try {
        const response = await fetch(`/api/shipstation/order/${orderNumber}`);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to load order');
        }

        const order = data.order;

        // Update status
        document.getElementById('drawerOrderStatus').textContent = order.orderStatus.replace(/_/g, ' ');

        // Build order details HTML
        let html = '';

        // Order Information
        html += '<div class="drawer-section">';
        html += '<h3>Order Information</h3>';
        html += '<div class="info-grid">';
        html += `<div class="info-item"><div class="info-label">Order Date</div><div class="info-value">${new Date(order.orderDate).toLocaleString()}</div></div>`;
        html += `<div class="info-item"><div class="info-label">Order Status</div><div class="info-value">${order.orderStatus}</div></div>`;
        html += `<div class="info-item"><div class="info-label">Payment Method</div><div class="info-value">${order.paymentMethod || '-'}</div></div>`;
        html += `<div class="info-item"><div class="info-label">Customer Email</div><div class="info-value">${order.customerEmail || '-'}</div></div>`;
        html += '</div>';
        html += '</div>';

        // Shipping Information
        if (order.carrierCode || order.serviceCode) {
          html += '<div class="drawer-section">';
          html += '<h3>Shipping Service</h3>';
          html += '<div class="shipping-info">';
          html += `<div class="service">${order.serviceCode || 'Standard Service'}</div>`;
          html += `<div class="carrier">Carrier: ${order.carrierCode || 'Not selected'}</div>`;
          html += `<div class="cost">Shipping: $${(order.shippingAmount || 0).toFixed(2)}</div>`;
          html += '</div>';
          html += '</div>';
        }

        // Ship To Address
        if (order.shipTo) {
          html += '<div class="drawer-section">';
          html += '<h3>Ship To</h3>';
          html += '<div class="address-box">';
          html += `<div class="name">${order.shipTo.name || 'Unknown'}</div>`;
          if (order.shipTo.company) html += `<div class="line">${order.shipTo.company}</div>`;
          if (order.shipTo.street1) html += `<div class="line">${order.shipTo.street1}</div>`;
          if (order.shipTo.street2) html += `<div class="line">${order.shipTo.street2}</div>`;
          html += `<div class="line">${order.shipTo.city || ''}, ${order.shipTo.state || ''} ${order.shipTo.postalCode || ''}</div>`;
          html += `<div class="line">${order.shipTo.country || ''}</div>`;
          if (order.shipTo.phone) html += `<div class="line">Phone: ${order.shipTo.phone}</div>`;
          html += '</div>';
          html += '</div>';
        }

        // Bill To Address
        if (order.billTo) {
          html += '<div class="drawer-section">';
          html += '<h3>Bill To</h3>';
          html += '<div class="address-box">';
          html += `<div class="name">${order.billTo.name || 'Unknown'}</div>`;
          if (order.billTo.company) html += `<div class="line">${order.billTo.company}</div>`;
          if (order.billTo.street1) html += `<div class="line">${order.billTo.street1}</div>`;
          if (order.billTo.street2) html += `<div class="line">${order.billTo.street2}</div>`;
          html += `<div class="line">${order.billTo.city || ''}, ${order.billTo.state || ''} ${order.billTo.postalCode || ''}</div>`;
          html += `<div class="line">${order.billTo.country || ''}</div>`;
          html += '</div>';
          html += '</div>';
        }

        // Line Items
        if (order.items && order.items.length > 0) {
          html += '<div class="drawer-section">';
          html += '<h3>Line Items</h3>';
          html += '<table class="line-items-table">';
          html += '<thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>';
          html += '<tbody>';

          order.items.forEach(item => {
            html += '<tr>';
            html += `<td>`;
            html += `<div class="item-name">${item.name || 'Unknown Item'}</div>`;
            html += `<div class="item-sku">SKU: ${item.sku || '-'}</div>`;

            // Item options
            if (item.options && item.options.length > 0) {
              html += '<div class="item-options">';
              item.options.forEach(opt => {
                html += `<span class="item-option">${opt.name || 'Option'}: ${opt.value || '-'}</span>`;
              });
              html += '</div>';
            }

            html += `</td>`;
            html += `<td>${item.quantity || 1}</td>`;
            html += `<td>$${(item.unitPrice || 0).toFixed(2)}</td>`;
            html += `<td>$${((item.quantity || 1) * (item.unitPrice || 0)).toFixed(2)}</td>`;
            html += '</tr>';
          });

          html += '</tbody>';
          html += '</table>';
          html += '</div>';
        }

        // Cost Summary
        html += '<div class="drawer-section">';
        html += '<h3>Order Summary</h3>';
        html += '<div class="cost-summary">';
        html += `<div class="cost-row"><span>Subtotal:</span><span>$${((order.orderTotal || 0) - (order.shippingAmount || 0) - (order.taxAmount || 0)).toFixed(2)}</span></div>`;
        html += `<div class="cost-row"><span>Shipping:</span><span>$${(order.shippingAmount || 0).toFixed(2)}</span></div>`;
        html += `<div class="cost-row"><span>Tax:</span><span>$${(order.taxAmount || 0).toFixed(2)}</span></div>`;
        html += `<div class="cost-row total"><span>Total:</span><span>$${(order.orderTotal || 0).toFixed(2)}</span></div>`;
        html += '</div>';
        html += '</div>';

        // Customer Notes
        if (order.customerNotes) {
          html += '<div class="drawer-section">';
          html += '<h3>Customer Notes</h3>';
          html += `<div class="address-box">${order.customerNotes}</div>`;
          html += '</div>';
        }

        // Internal Notes
        if (order.internalNotes) {
          html += '<div class="drawer-section">';
          html += '<h3>Internal Notes</h3>';
          html += `<div class="address-box">${order.internalNotes}</div>`;
          html += '</div>';
        }

        content.innerHTML = html;

      } catch (error) {
        content.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${error.message}</p></div>`;
      }
    }

    function closeOrderDrawer() {
      document.getElementById('orderDrawer').classList.remove('open');
      document.getElementById('orderDrawerOverlay').classList.remove('show');
    }

    // Close drawer on ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeOrderDrawer();
      }
    });
  </script>
</body>
</html>
